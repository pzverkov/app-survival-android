<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta id="themeColor" name="theme-color" content="#0f131c" />
    <title>App Survival: Android Release Night</title>
  </head>
  <body>
    <div id="app" class="wrap">
      <canvas id="c"></canvas>

      <aside class="side">
        <div class="sideHeader">
          <h1>App Survival: Android Release Night <span class="badge">M3 • TS + Vite</span></h1>

          <div class="row">
            <button id="btnStart" class="btn filled">▶ Start</button>
            <button id="btnPause" class="btn tonal">⏸ Pause</button>
            <button id="btnReset" class="btn error">↺ Reset</button>
          </div>

          <div class="row" style="margin-top:10px; align-items:center;">
            <span class="pill" id="modePill">Mode: <b>Select</b></span>
            <div class="row segmented" role="group" aria-label="Mode" style="margin-left:auto;">
              <button id="btnSelect" class="btn text is-selected">Select</button>
              <button id="btnLink" class="btn text">Link</button>
              <button id="btnUnlink" class="btn text">Unlink</button>
            </div>
          </div>
        </div>

        <!-- Keep "Selected" high in the panel for fast diagnosis/repair cycles -->
        <section class="card" id="selCard">
          <div class="k">Selected</div>
          <div class="v mono" id="selName">None</div>
          <pre class="small mono" id="selStats">—</pre>
          <div class="row" style="margin-top:10px;">
            <button id="btnUpgrade" class="btn filled" disabled>Upgrade</button>
            <button id="btnRepair" class="btn outlined" disabled>Repair</button>
            <button id="btnDelete" class="btn error" disabled>Delete</button>
          </div>
          <div class="small" style="margin-top:8px;">
            Upgrades raise capacity & reliability. Repairs restore health. Both cost budget
          </div>
        </section>

        <!-- High-signal observability block -->
        <section class="metricsGrid">
          <div class="card">
            <div class="k">Budget</div>
            <div class="v mono" id="budget">$500</div>
            <div class="small">Run dies at $0 or rating 1.0★</div>
          </div>
          <div class="card">
            <div class="k">Time</div>
            <div class="v mono" id="time">0s</div>
            <div class="small">Sim time</div>
          </div>
          <div class="card">
            <div class="k">Rating</div>
            <div class="v mono" id="rating">5.0 ★</div>
            <div class="small">Drops from failures / ANRs / slow</div>
          </div>
          <div class="card">
            <div class="k">Score</div>
            <div class="v mono" id="score">0</div>
            <div class="small">Deterministic per seed</div>
          </div>
          <div class="card">
            <div class="k">Architecture</div>
            <div class="v mono" id="archDebt">0</div>
            <div class="small">Debt (0..100)</div>
          </div>
          <div class="card">
            <div class="k">Failures</div>
            <div class="v mono" id="fail">0.0%</div>
            <div class="small">Too many = review bombs</div>
          </div>
          <div class="card">
            <div class="k">Coverage</div>
            <div class="v mono" id="coverage">78%</div>
            <div class="small" id="coverageHint">Target 70%+</div>
          </div>
          <div class="card">
            <div class="k">ANR Risk</div>
            <div class="v mono" id="anr">0.0%</div>
            <div class="small">Main thread pain</div>
          </div>
          <div class="card">
            <div class="k">p95 Latency</div>
            <div class="v mono" id="lat">0 ms</div>
            <div class="small">Queueing makes it worse</div>
          </div>
          <div class="card">
            <div class="k">Battery</div>
            <div class="v mono" id="bat">100</div>
            <div class="small">Work spam drains</div>
          </div>

          <div class="card">
            <div class="k">Jank</div>
            <div class="v mono" id="jank">0%</div>
            <div class="small">FrameGuard 16ms</div>
          </div>
          <div class="card">
            <div class="k">Heap</div>
            <div class="v mono" id="heap">64 MB</div>
            <div class="small">HeapWatch GC <span class="mono" id="gc">0</span> ms • OOM <span class="mono" id="oom">0</span></div>
          </div>
        </section>

        <!-- Seed controls (required by src/main.ts). Kept lightweight so runs can be shared/replayed. -->
        <section class="card">
          <div class="k">Seed</div>
          <div class="small" style="margin-top:8px;">
            Active: <span id="seedVal" class="mono">0</span>
          </div>
          <div class="row" style="margin-top:8px; gap:8px;">
            <input id="seedInput" class="input" style="flex:1;" type="number" step="1" placeholder="Seed (optional)" />
            <button id="btnDailySeed" class="btn text" title="Use a deterministic daily seed">Daily</button>
          </div>
          <div class="small muted" style="margin-top:8px;">Reset uses the seed above (if set).</div>
        </section>


        <section class="card">
          <div class="k">Trust &amp; accessibility</div>
          <div class="small" style="margin-top:8px;">
            A11y: <span class="mono" id="a11yScore">100</span>/100 •
            Privacy: <span class="mono" id="privacyTrust">100</span>/100 •
            Security: <span class="mono" id="securityPosture">100</span>/100 •
            Support load: <span class="mono" id="supportLoad">0</span>/100
          </div>
        </section>

        <!-- Setup & controls: these become a 2-col grid on wider viewports -->
        <div class="sideGroup">
          <section class="card">
            <div class="k">Evaluation preset</div>
            <div class="row" style="margin-top:8px;">
              <select id="presetSelect">
                <option value="JUNIOR_MID">Junior-Mid</option>
                <option value="SENIOR">Senior</option>
                <option value="STAFF">Staff</option>
                <option value="PRINCIPAL">Principal</option>
              </select>
            </div>
            <div class="small muted" style="margin-top:8px;">CoverageGate and enforcement weight</div>
          </section>

          <section class="card">
            <div class="k">Place component</div>
            <div class="row" style="margin-top:8px;">
              <select id="componentType">
                <option value="UI">UI</option>
                <option value="VM">ViewModel</option>
                <option value="DOMAIN">Domain</option>
                <option value="REPO">Repository</option>
                <option value="CACHE">Cache</option>
                <option value="DB">Room DB</option>
                <option value="NET">Network</option>
                <option value="WORK">WorkManager</option>
                <option value="OBS">Observability</option>
                <option value="FLAGS">Feature Flags</option>
                <option value="AUTH">Auth / Sessions</option>
                <option value="PINNING">TLS Pinning</option>
                <option value="KEYSTORE">Keystore / Crypto</option>
                <option value="SANITIZER">Input Sanitizer</option>
                <option value="ABUSE">Abuse Protection</option>
                <option value="A11Y">Accessibility Layer</option>
              </select>
              <button id="btnAdd" class="btn tonal">+ Add</button>
            </div>
            <div class="small" style="margin-top:8px;">
              Drag components to rearrange. Link mode: click <span class="mono">source</span> → click <span class="mono">destination</span>
            </div>
          </section>
        </div>

        <section class="card" id="backlogCard">
          <div class="k">Backlog</div>
          <div class="row" style="margin-top:8px; align-items:center;">
            <div class="pill">Capacity <span id="capVal" class="mono">0/0</span></div>
            <div class="small muted" style="margin-left:auto;">Fix tickets or defer</div>
          </div>
          <div id="ticketList" class="ticketList" style="margin-top:10px;"></div>
        </section>

        <div class="sideGroup">
          <section class="card">
            <div class="k">Platform</div>
            <div class="small" style="margin-top:8px;">
              Latest API <span id="apiLatest" class="mono">0</span> • Min API <span id="apiMin" class="mono">0</span>
            </div>
            <div class="small muted" style="margin-top:4px;">
              Old devices <span id="oldShare" class="mono">0</span>% • Low RAM <span id="lowRamShare" class="mono">0</span>%
            </div>
            <div id="advisoryText" class="small" style="margin-top:8px;"></div>
          </section>

          <section class="card">
            <div class="k">Regions</div>
            <div class="row" style="margin-top:8px; align-items:center;">
              <div class="pill">Reg pressure <span id="regPressure" class="mono">0</span></div>
              <div class="small muted" style="margin-left:auto;">Compliance and rollout gates</div>
            </div>
            <div id="regionList" class="regionList" style="margin-top:10px;"></div>
          </section>
        </div>

        <section class="card">
          <div class="k">User votes (live sentiment)</div>
          <div class="small" style="margin-top:8px;">
            Perf: <span class="mono" id="votesPerf">0</span> •
            Reliability: <span class="mono" id="votesReliability">0</span> •
            Privacy: <span class="mono" id="votesPrivacy">0</span> •
            A11y: <span class="mono" id="votesA11y">0</span> •
            Battery: <span class="mono" id="votesBattery">0</span>
          </div>
          <pre class="small" id="reviewLog" style="margin-top:8px;">No reviews yet.</pre>
        </section>

        <section class="card" id="incidentsCard">
          <div class="k">Incidents</div>
          <pre class="small" id="eventLog">No incidents… yet.</pre>
        </section>
        <section class="card">
          <div class="row" style="align-items:center;">
            <div class="k">Postmortem</div>
            <div style="margin-left:auto;">
              <button id="btnCopyRun" class="btn text">Copy run JSON</button>
            </div>
          </div>
          <pre class="small" id="postmortem">No run yet.</pre>
        </section>

        <section class="card">
          <div class="row" style="align-items:center;">
            <div class="k">Scoreboard (local)</div>
            <div style="margin-left:auto;">
              <button id="btnClearScoreboard" class="btn text">Clear</button>
            </div>
          </div>
          <div class="small muted" style="margin-top:6px;">Top runs stored in localStorage.</div>
          <pre class="small" id="scoreboardList" style="margin-top:8px;">No scores yet.</pre>
        </section>
        <section class="card">
          <div class="row" style="align-items:center;">
            <div class="k">Refactor Roadmap</div>
            <div style="margin-left:auto;">
              <button id="btnApplyNextRoadmap" class="btn text">Apply next</button>
            </div>
          </div>
          <div class="small muted" style="margin-top:6px;">Suggested sequence to pay down architecture debt (Staff/Principal-style).</div>
          <pre class="small" id="roadmap" style="margin-top:8px;">No roadmap yet.</pre>
        </section>


        <section class="card">
          <div class="k">Android realism features (implemented)</div>
          <ol class="small" style="margin:8px 0 0; padding-left:18px;">
            <li><b>FrameGuard</b> frame budget and jank meter (16ms model)</li>
            <li><b>MainThreadGuard</b> IO on main strictness (adds ANR and jank)</li>
            <li><b>HeapWatch</b> heap meter with GC pauses and OOM crashes</li>
          </ol>
        </section>

        <p class="small">
          Recommended starter graph: <span class="mono">UI → VM → Domain → Repo → (Cache → DB)</span> and <span class="mono">Repo → Net</span>.
          Add <span class="mono">Observability</span> + <span class="mono">Feature Flags</span> to reduce blast radius
        </p>

        <!-- Footer: keep theme controls at the bottom, away from the "hot path" -->
        <div class="sideFooter">
          <div class="row" style="align-items:center;">
            <div class="pill">Theme</div>
            <select id="themeSelect" style="margin-left:auto;">
              <option value="system">System</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>

          <div class="row" style="margin-top:10px; align-items:center;">
            <div class="pill">Glass</div>
            <select id="glassSelect" style="margin-left:auto;">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>

          <div id="buildInfo" class="small mono" style="opacity:.75; margin-top:10px;"></div>
        </div>

      </aside>
    </div>

    <!-- Incident response: shown briefly when a new incident hits -->
    <div id="incidentOverlay" class="incidentOverlay" hidden aria-live="polite" aria-atomic="true">
      <div class="card incidentOverlayInner">
        <div class="row" style="align-items:center;">
          <div class="pill" style="border-color: color-mix(in oklab, var(--md-sys-color-error) 70%, transparent);">Incident</div>
          <div id="incidentOverlayTitle" class="small mono" style="margin-left:10px; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">—</div>
          <button id="incidentOverlayDismiss" class="btn text" aria-label="Dismiss incident">✕</button>
        </div>
        <div id="incidentOverlayHint" class="small muted" style="margin-top:8px;">Respond fast: fix or defer the top ticket to stop the bleed.</div>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button id="incidentOverlayBacklog" class="btn outlined">Open backlog</button>
          <button id="incidentOverlayTriage" class="btn filled">Quick triage</button>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>